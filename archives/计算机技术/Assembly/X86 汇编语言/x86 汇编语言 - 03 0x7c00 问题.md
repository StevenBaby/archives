# x86 汇编语言 - 03 0x7c00 问题

[annotation]: [id] (27e11258-7f41-45c0-842c-99372e7f069f)
[annotation]: [status] (protect)
[annotation]: [create_time] (2021-05-04 01:26:48)
[annotation]: [category] (计算机技术)
[annotation]: [tags] (汇编语言)
[annotation]: [comments] (false)
[annotation]: <topic> (x86 汇编语言)
[annotation]: <index> (3)
[annotation]: [url] (http://blog.ccyg.studio/article/27e11258-7f41-45c0-842c-99372e7f069f)

英特尔公司的处理器很牛皮啊，以至于我们现在还需要学习，上一个视频中说了，关于 `0x7c00` 的问题，以及实模式下的内存布局，布局如下：

| 起始地址  | 结束地址  | 大小     | 用途               |
| --------- | --------- | -------- | ------------------ |
| `0x000`   | `0x3FF`   | 1KB      | 中断向量表         |
| `0x400`   | `0x4FF`   | 256B     | BIOS 数据区        |
| `0x500`   | `0x7BFF`  | 29.75 KB | 可用区域           |
| `0x7C00`  | `0x7DFF`  | 512B     | MBR 加载区域       |
| `0x7E00`  | `0x9FBFF` | 607.6KB  | 可用区域           |
| `0x9FC00` | `0x9FFFF` | 1KB      | 扩展 BIOS 数据区   |
| `0xA0000` | `0xAFFFF` | 64KB     | 用于彩色显示适配器 |
| `0xB0000` | `0xB7FFF` | 32KB     | 用于黑白显示适配器 |
| `0xB8000` | `0xBFFFF` | 32KB     | 用于文本显示适配器 |
| `0xC0000` | `0xC7FFF` | 32KB     | 显示适配器 BIOS    |
| `0xC8000` | `0xEFFFF` | 160KB    | 映射内存           |
| `0xF0000` | `0xFFFEF` | 64KB-16B | 系统 BIOS          |
| `0xFFFF0` | `0xFFFFF` | 16B      | 系统 BIOS 入口地址 |


细心的朋友可能已经发现了，就是这块内存区域特别的不规则，可用区域有两块，而且分的很开，这其实就是英特尔纵横天下最强大手段，那就是向下兼容，向下兼容是一个很有效的抢夺竞争对手用户的手段；用户习惯是很难养成的，养成之后又是很难改变的，于是软件兼容就是硬件首先要考虑的事情。如果硬件不兼容，即便是你再牛逼，跑不了我自己的软件，那我肯定不买账啊。

于是这里内存区域分成了两部分，一部分是 `0x000` ~ `0x7fff` 的区域，这是一开始的某个机器使用的内存，总共有 `32KB` 的大小。另一部分是 `32KB` 之后的部分，这部分内容绝大数数与众不同的地方是显卡的内存映射。

## IBM PC 5150 

如你所愿，那不规则的 32KB 的内存区域，就是 IBM PC 5150 使用的内存区域，IBM PC 5150 如下图所示：

![](http://www.oldcomputermuseum.com/ibm-5150/ibm-5150.jpg)

IBM PC 5150 要求的最小内存是 16KB，不是 32 KB，这样就不能加载到 0x7c00 了怎么办？

另一个要求是，如果想要运行 DOS 1.0 那么就必须至少需要 32KB 的内存，IBM PC 5150 是 1981 年开发的，可见当时还有其他的操作系统。

BIOS 是由 IBM 开发的，也就是说 `0x7c00` 是由 IBM 的开发团队决定的，那么为什么要选择这个地址呢？有以下几个原因：

- 内存区域 0x0 - 0x3ff 用于系统中断
- 希望给使用者更多的内存空间
- 引导扇区有 512 个字节
- 引导程序使用的栈还需要 512 个字节
- 引导程序总共需要 1KB 的空间，上面两项加起来
- 把这个 1KB 放到了 32KB 的最后，似乎是比较合理的选择

于是就这样选择了 31 KB 的位置，也就是 $31 \times 1024 = 0x7c00$。

那么下面就是 IBM PC 5150 的内存分布图：

| 起始地址 | 结束地址 | 大小     | 用途         |
| -------- | -------- | -------- | ------------ |
| `0x000`  | `0x3FF`  | 1KB      | 中断向量表   |
| `0x400`  | `0x4FF`  | 256B     | BIOS 数据区  |
| `0x500`  | `0x7BFF` | 29.75 KB | 可用区域     |
| `0x7C00` | `0x7DFF` | 512B     | MBR 加载区域 |
| `0x7E00` | `0x7FFF` | 512B     | MBR 栈空间   |

后期开发的软件都需要兼容 IBM PC 5150，但是后期的内存空间都比 32KB 要大，所以引导程序的栈也就不必非蜷缩在 `0x7E00` ~ `0x7fff` 这 512B 里了。这 512B 随后便混迹在更大的内存区域中，销声匿迹了。

一般人编程都喜欢用整数开始，不如 0x1000 或者 0x10000 等等，后期内存区域很大，谁稀罕这 512 字节，不过在当时内存可是寸土寸金啊，这也为后期开发者想尽办法兼容这个特性造成了很多困扰。

## IBM PC 5150 相关历史

IBM PC 5150 终结了 CP/M。

在1980年早期，IBM决定创建微型计算机(到目前为止，IBM 只生产小型计算机和大型计算机)。他们并不真正知道他们想要的，他们从未想过生产微型计算机是一个有利可图的行业(谁能想到呢？) 在英特尔 8086(16位) 和摩托罗拉 MC68000 之间犹豫不决之后，他们决定使用英特尔 8088 (8 - 16位) 处理器，因为 IBM 觉得其他两款处理器太强大了!

然后他们要求数字研究公司（Digital Research Inc.）(CP/M 的创造者)为他们的新电脑创建一个操作系统。因为数字研究公司不是很感兴趣，于是他们请了一家小公司微软(以 BASIC 编程语言闻名) 来编写操作系统。

微软没有这个能力。比尔·盖茨购买了一个小型操作系统的版权，该操作系统是由一家名为西雅图电脑产品公司的小公司编写的系统 QDOS，QDOS 被黑客攻击过。QDOS (据说是“快速而肮脏的操作系统(Quick and Dirty Operating System)” 的缩写，它本身与 CP/M 有着惊人的相似之处)，后来变成了PC-DOS，后来又变成了MS-DOS!

最初的 IBM 个人电脑不是很强大(在当时肯定不如许多 8 位计算机强大)。第一个PC 只有 16MB 的内存，没有软盘单元，他们使用盒式磁带来加载和存储程序(注意，处理盒式磁带驱动器的命令从操作系统一直到 MS-DOS 5!)

由于 IBM 的名字和声誉，它成为了一种标准，直到 80 年代末，IBM 一直在商业计算机市场上运行。现在，我们可以想到大约 90% 的微型计算机与 PC 兼容，并可以在 MS-DOS 或 Windows 下运行(在开始时，Windows 只是 MS-DOS 的图形界面，但那是另一回事了)。

虽然 IBM PC XT 是在 1983 年推出的，但 IBM 继续以各种配置生产这两款产品达数年之久。模型类型后面跟着一个 xx 版本号，例如 5150-xx，其中 xx 表示包含的选项(内存容量，单或双软盘驱动器，等等)。

当这些电脑(PC 和 XT)最初出售时，它们是按订单生产的电脑(听起来像 Gateway 或 戴尔，不是吗?) 零售店将销售工厂生产的产品，包括一个盒装电脑和基本部件，如主板，电源，软盘和软驱等。PC 和 XT 没有官方的基础模型配置，也没有任何数据备份和恢复。客户可以选择内存、显示器、串行端口等，他们可以在电脑回家之前就地安装。一个人不能购买一个“新的” PC/XT 并运行它的盒子，因为它是不完整的，没有额外的配置。

PC 可以使用 CGA 或 MDA(在MPA卡上)。CGA 适配器实际上有一个 RCA 复合输出，将其连接到您的电视，如果您不想要 CGA 监视器。输出质量是完美的!

PC 产品线的另一个显著特点是扩展底座:它在外部机箱中增加了额外的 8 位插槽。

IBM PC 5150 是 1981 年发布的，直到 1986-1987 年 VGA 才被 IBM 标准化，也就是说 32KB 后面的部分是 1987 年才定下来的，而且也是 IBM 做的，和英特尔没关系。

## PC/M

上文引出了另一个名词 那就是 PC/M，这是 IBM PC 机操作系统的鼻祖。最初应用在 Intel 4004 上。

## 参考资料

- <https://www.glamenv-septzen.net/en/view/6>
- <http://www.oldcomputermuseum.com/ibm_5150.html>