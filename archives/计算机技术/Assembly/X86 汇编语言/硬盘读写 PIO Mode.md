# 硬盘读写 PIO Mode

[annotation]: <id> (6ad8c31c-1bd6-4827-b35c-688b0a068d8b)
[annotation]: <status> (public)
[annotation]: <create_time> (2021-03-10 13:03:39)
[annotation]: <category> (计算机技术)
[annotation]: <tags> (汇编语言)
[annotation]: <comments> (false)
[annotation]: <topic> (x86汇编语言)
[annotation]: <index> (1)
[annotation]: <url> (http://blog.ccyg.studio/article/6ad8c31c-1bd6-4827-b35c-688b0a068d8b)

一般来说，我们把这些设备分成两种，一种是输入设备，比如键盘、鼠标、麦克风、摄像头等；另一种是输出设备，比如显示器、打印机、扬声器等。输入设备和输出
设备统称输入输出(Input/Output, I/O) 设备。

----

外围设备和处理器之间的通信是通过相应的 I/O 接口进行的。当然，这么说太过于笼统，所以必须具体到细节上来讲这件事。

具体地说，处理器是通过端口 (Port) 来和外围设备打交道的。本质上，端口就是一些寄存器，类似于处理器内部的寄存器。不同之处仅仅在于，这些叫做端口的寄存器位于 I/O 接口电路中。

端口是处理器和外围设备通过 I/O 接口交流的窗口，每一个 I/O 接口都可能拥有好几个端口，分别用于不同的目的。

---

根据 ATA 的说明，PIO 模式必须在 ATA 兼容的设备上作为默认的数据传输机制。

PIO 模式会使用过多的 CPU 资源，因为在磁盘和 CPU 之间传输数据的每个字节都必须发送到 CPU 的IO端口总线，而不是内存，在一些CPU上，PIO 模式仍然可以达到 $16MB/s$ 的实际速度。

然而，当计算机刚刚启动的时候，没有任何的其他进程，所以 PIO 模式在设备刚刚启动时是一种简单而有效的接口，直到系统进入多任务模式。

## 硬件

ATA 磁盘说明是通过老说明 ST506 创建的，在 ST506 中，每个磁盘启动器通过两根线缆连接到控制板中，一根控制线，另一根是数据线。控制板被直接插到母板的总线中，CPU 通过 IO 端口来和控制板通信。

连接硬盘的 PATA/SATA 接口就有几个端口，分别是：

- 命令端口
    - `0x20` 表示读数据
    - `0x30` 表示写数据
- 状态端口：处理器根据这个端口的数据来判断硬盘工作是否正常，操作是否成功，发生了哪种错误
- 参数端口：处理器通过这些端口告诉硬盘读写的扇区数量，以及起始的逻辑扇区号
- 数据端口：通过这个端口连续地取得要读出的数据，或者通过这个端口连续地发送要写入硬盘的数据

端口在不同的计算机系统中有着不同的实现方式。在一些计算机系统中，端口号是映射到内存地址空间的。比如 `0x00000 ~ 0xE0000` 是真实的物理内存地址，而 `0xE0001 ~ 0xFFFFF` 是从很多 I/O 接口那里映射过来的， 当访问这部分地址时，实际上是在访问 I/O 接口

----

每个 PATA 和 SATA 接口分配了 8 个端口。但是，ICH 芯片内部通常集成了两个 PATA/SATA 接口，分别是主硬盘接口和副硬盘接口。这样一来，主硬盘接口分配的端口号是 `0x1f0 ~ 0x1f7`，副硬盘接口分配的端口号是 `0x170 ~ 0x177`。

## 读取数据

## 参考资料

- [李忠 - X86汇编语言](https://book.douban.com/subject/20492528/)
- <https://wiki.osdev.org/ATA_PIO_Mode>

