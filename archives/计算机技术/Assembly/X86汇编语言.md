# X86汇编语言

[annotation]: <id> (c4d0635c-fcc9-410d-aedb-c481fb5dd5c7)
[annotation]: <status> (public)
[annotation]: <create_time> (2021-02-04 14:31:43)
[annotation]: <category> (计算机技术)
[annotation]: <tags> (汇编语言)
[annotation]: <comments> (true)
[annotation]: <url> (http://blog.ccyg.studio/article/c4d0635c-fcc9-410d-aedb-c481fb5dd5c7)


## 编写主引导扇区代码

```s
    base equ 0x7c00;
    video equ 0xb800;

    mov ax, 0x0003; clear screen
    int 0x10;

    mov ax,video  ;指向文本模式的显示缓冲区
    mov es,ax

    ;以下显示字符串"Label offset:"
    mov byte [es:0x00],'L'
    mov byte [es:0x01],0x07
    mov byte [es:0x02],'a'
    mov byte [es:0x03],0x07
    mov byte [es:0x04],'b'
    mov byte [es:0x05],0x07
    mov byte [es:0x06],'e'
    mov byte [es:0x07],0x07
    mov byte [es:0x08],'l'
    mov byte [es:0x09],0x07
    mov byte [es:0x0a],' '
    mov byte [es:0x0b],0x07
    mov byte [es:0x0c],"o"
    mov byte [es:0x0d],0x07
    mov byte [es:0x0e],'f'
    mov byte [es:0x0f],0x07
    mov byte [es:0x10],'f'
    mov byte [es:0x11],0x07
    mov byte [es:0x12],'s'
    mov byte [es:0x13],0x07
    mov byte [es:0x14],'e'
    mov byte [es:0x15],0x07
    mov byte [es:0x16],'t'
    mov byte [es:0x17],0x07
    mov byte [es:0x18],':'
    mov byte [es:0x19],0x07

    mov ax,number                 ;取得标号number的偏移地址
    mov bx,10


    ;设置数据段的基地址
    mov cx,cs
    mov ds,cx

    ;求个位上的数字
    mov dx,0
    div bx
    mov [0x7c00+number+0x00],dl   ;保存个位上的数字

    ;求十位上的数字
    xor dx,dx
    div bx
    mov [0x7c00+number+0x01],dl   ;保存十位上的数字

    ;求百位上的数字
    xor dx,dx
    div bx
    mov [0x7c00+number+0x02],dl   ;保存百位上的数字

    ;求千位上的数字
    xor dx,dx
    div bx
    mov [0x7c00+number+0x03],dl   ;保存千位上的数字

    ;求万位上的数字 
    xor dx,dx
    div bx
    mov [0x7c00+number+0x04],dl   ;保存万位上的数字

    ;以下用十进制显示标号的偏移地址
    mov al,[0x7c00+number+0x04]
    add al,0x30
    mov [es:0x1a],al
    mov byte [es:0x1b],0x04
    
    mov al,[0x7c00+number+0x03]
    add al,0x30
    mov [es:0x1c],al
    mov byte [es:0x1d],0x04
    
    mov al,[0x7c00+number+0x02]
    add al,0x30
    mov [es:0x1e],al
    mov byte [es:0x1f],0x04

    mov al,[0x7c00+number+0x01]
    add al,0x30
    mov [es:0x20],al
    mov byte [es:0x21],0x04

    mov al,[0x7c00+number+0x00]
    add al,0x30
    mov [es:0x22],al
    mov byte [es:0x23],0x04
    
    mov byte [es:0x24],'D'
    mov byte [es:0x25],0x07
    
infi: jmp near infi                 ;无限循环

number db 0,0,0,0,0

times   510 - ($ - $$) db 0
        dw 0xaa55; db 0x55,0xaa
```

- 注释：必须以英文字母 ; 开始。

---

主引导扇区 (MBR Main Boot Sector) 数据有 512 字节，ROM-BIOS 程序将它加载到逻辑地址 0x0000:0x7c00 处，然后判断它是否有效。

一个有效的主引导扇区，最后两个字节应该是 0x55 和 0xAA，如果主引导扇区有效，则以一个段间转移指令 jmp 0x0000:0x7c00 跳到那里继续执行。

---

8086 可以访问 1MB 内存，其中：

- 0x00000-0x9ffff 属于常规内存，由内存条提供；
- 0xa0000-0xeffff 由特定的外围设备提供；
- 0xf0000-0xfffff 由主板上的一个芯片提供，ROM-BIOS；

其中 0xa0000-0xeffff 就包括显卡，由于历史原因，所有在个人计算机上使用的显卡，在加电自检后都会把自己初始化到 80x25 的文本模式，在这种模式下可以显示 25 行，每行 80 个字符，每屏总共 2000 个字符。

0xb8000 - 0xbffff 是留给显卡的，由显卡来提供。

---

- 不允许 `mov` 立即数到 段寄存器
- 关键字 `byte` 用来修饰目的操作数，指出本次传送是以字节的方式进行的。
- `mov` 指令的目的操作数不允许为立即数

```s
    mov byte [es:0xf9e],0x48
    mov byte [es:0xf9f],0x27

    ; mov al, 0x55aa ; warning 数据溢出 warning: byte data exceeds bounds
    ; mov ds, 0x6000; invalid combination of opcode and operands
    ; mov ds, al; invalid combination of opcode and operands
    ; mov [0x06], 0x55aa; error: operation size not specified
    mov ds, bx;
    mov ax, 0x02;
    mov word [0x0a], ax;
    mov es, cx;
    ; mov ax, bl; invalid combination of opcode and operands
    mov byte [0x00], 'C';
    ; mov [0x02], [0xf000]; invalid combination of opcode and operands
    mov ds, [0x03];
```

检测点 5.2 

```s
data1 db 0x55, 0xf000, 0x0f; warning: byte data exceeds bounds [-w+number-overflow]
data2 dw 0x38, 0x20, 0x55aa
```

